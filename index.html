<!DOCTYPE html>
    <html>
        <head>
            <title>Will Probabilities</title>
            <meta charset="UTF-8">
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
            <style>
                body{
                    align-content: center;
                    font-family: arial;
                }
                table, th, td{
                    border: 1px solid black;
                }
                td{
                    text-align: center;
                }
                table {
                    margin-left: auto;
                    margin-right: auto;
                    border-collapse: collapse;
                    width: 50%;
                    table-layout: fixed;
                }
                div {
                    align-content: center;
                    padding: 10px;
                }
            </style>
        </head>
        <body>
            <div id='matrixDiv'>

            </div>
            <div id='pickTableDiv'>
                
            </div>
            <div id='comboTableDiv'>
                
            </div>
            <script>

                $.ajaxSetup({async:false})

                var willNames = []
                $.getJSON("https://api.sibr.dev/proxy/database/offseasonSetup", populateWillNames)

                $.getJSON("https://api.sibr.dev/proxy/database/teamElectionStats", {
                                'id': '3f8bbb15-61c0-4e3f-8e4a-907a5fb1565e'
                            }, createTable)

                function createTable(electionStats){

                    let wills = electionStats.wills
                    wills.sort(function(a,b){
                        return b.percent - a.percent
                    })

                    let individualPercentages = getIndividualPercentages(wills)
                    
                    // var freeWillMatrix = calculate3DProbabilityMatrix(individualPercentages)
                    // freeWillMatrix.forEach(innerMatrix => printTable(innerMatrix))

                    let matrix = calculateProbabilityMatrix(individualPercentages)
                    printTable(matrix)
                    
                    let secondPickPercentages = calculate2ndPickProbabilities(matrix)

                    let pickTable = document.createElement('table')
                    let tableBody = document.createElement('tbody')

                    for (let i = 0; i < wills.length; i++){
                        let tableRow = document.createElement('tr')
                        let tableCell = document.createElement('th')
                        tableCell.appendChild(document.createTextNode(willNames[wills[i].id]))
                        tableRow.appendChild(tableCell)
                        tableCell = document.createElement('td')
                        tableCell.appendChild(document.createTextNode(round(wills[i].percent, 2)))
                        tableRow.appendChild(tableCell)
                        tableCell = document.createElement('td')
                        tableCell.appendChild(document.createTextNode(round(secondPickPercentages[i] * 100, 2)))
                        tableRow.appendChild(tableCell)
                        tableCell = document.createElement('td')
                        tableCell.appendChild(document.createTextNode(round((secondPickPercentages[i] + individualPercentages[i]) * 100, 2)))
                        tableRow.appendChild(tableCell)
                        tableBody.appendChild(tableRow)
                    }
                    pickTable.appendChild(tableBody)
                    document.getElementById('pickTableDiv').appendChild(pickTable)


                    let orderedCombos = calculateOrderedCombinationProbabilities(wills, matrix)
                    orderedCombos.sort(function(a,b){
                        return b.value - a.value
                    })

                    let comboTable = document.createElement('table')
                    let comboTableBody = document.createElement('tbody')
                    for (let i = 0; i < 10 && i < orderedCombos.length; i++){
                        let row = document.createElement('tr')
                        let cell = document.createElement('th')
                        cell.appendChild(document.createTextNode(getCombinationDisplayString(orderedCombos[i].combination)))
                        row.appendChild(cell)
                        cell = document.createElement('td')
                        cell.appendChild(document.createTextNode(round(orderedCombos[i].value * 100,2)))
                        row.appendChild(cell)
                        comboTableBody.appendChild(row)
                    }
                    comboTable.appendChild(comboTableBody)
                    document.getElementById('comboTableDiv').appendChild(comboTable)
                }

                function populateWillNames(offSeasonData){
                    offSeasonData.wills.forEach(will => {
                        willNames[will.id] = will.title
                    })
                }

                function printTable(probabilityMatrix){

                    let willTable = document.createElement('table')
                    let tableBody = document.createElement('tbody')
                    probabilityMatrix.forEach(matrixRow => {
                        let tableRow = document.createElement('tr')
                        matrixRow.forEach(matrixCell => {
                            let tableCell = document.createElement('td')
                            tableCell.appendChild(document.createTextNode(round(matrixCell * 100, 2)))
                            tableRow.appendChild(tableCell)
                        })
                        tableBody.appendChild(tableRow)
                    })
                    willTable.appendChild(tableBody)
                    document.getElementById('matrixDiv').appendChild(willTable)
                }

                function getIndividualPercentages(wills){
                    let percentages = []
                    let total = 0
                    wills.forEach(will => {total += (parseFloat(will.percent))})
                    
                    for (let i = 0; i < wills.length; i++){
                        percentages[i] = wills[i].percent / total
                    }
                    return percentages
                }

                function calculateProbabilityMatrix(individualPercentages){
                    let percentages = []
                    for (let x = 0; x < individualPercentages.length; x++){
                        percentages[x] = []
                        let remaining = 1 - individualPercentages[x]
                        for (let y = 0; y < individualPercentages.length; y++){
                            let yProb = 0
                            if (x != y){
                                yProb = individualPercentages[y]/remaining
                            }
                            percentages[x][y] = (yProb * individualPercentages[x])
                        }
                    }
                    return percentages
                }

                function calculate3DProbabilityMatrix(individualPercentages){
                    let percentages = []
                    for (let x = 0; x < individualPercentages.length; x++){
                        percentages[x] = []
                        let xProb = individualPercentages[x]
                        let remaining = 1 - individualPercentages[x]
                        for (let y = 0; y < individualPercentages.length; y++){
                            percentages[x][y] = []
                            let stillRemaining = remaining - individualPercentages[y]
                            let yProb = 0
                            if (x != y){
                                yProb = individualPercentages[y]/remaining
                            }
                            for (let z = 0; z < individualPercentages.length; z++){
                                zProb = 0
                                if (x != z && y != z){
                                    zProb = individualPercentages[z]/stillRemaining
                                }
                                percentages[x][y][z] = xProb * yProb * zProb
                            }
                        }
                    }
                    return percentages
                }

                function calculateOrderedCombinationProbabilities(wills, probabilityMatrix)
                {
                    let combinations = []
                    for (let x = 0; x < probabilityMatrix.length-1; x++){
                        for (let y = x+1; y < probabilityMatrix.length; y++){
                            let entry = {}
                            entry.combination = [wills[x].id,wills[y].id]
                            entry.value = probabilityMatrix[x][y] + probabilityMatrix[y][x]
                            combinations.push(entry)
                        }
                    }
                    return combinations
                }

                function calculate2ndPickProbabilities(probabilityMatrix){
                    let pickProbabilities = []
                    for (let y = 0; y < probabilityMatrix.length; y++){
                        let pickProbability = 0
                        for (let x = 0; x < probabilityMatrix.length; x++){
                            pickProbability += probabilityMatrix[x][y]
                        }
                        pickProbabilities[y] = pickProbability
                    }
                    return pickProbabilities
                }

                function round(toBeRounded, decimalPlaces){
                    let multiplier = Math.pow(10, decimalPlaces)
                    return Math.round(toBeRounded * multiplier) / multiplier
                }

                function getCombinationDisplayString(combinationIds){
                    let comboString = willNames[combinationIds[0]]
                    for (i = 1; i < combinationIds.length; i++){
                        comboString += ", "
                        comboString += willNames[combinationIds[i]]
                    }
                    return comboString
                }

            </script>
        </body>
    </html>
