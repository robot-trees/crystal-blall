<!DOCTYPE html>
    <html>
        <head>
            <title>Will Probabilities</title>
            <meta charset="UTF-8">
            <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' />
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
            <style>
                body{
                    align-content: center;
                    align-items: center;
                    font-family: "Roboto";
                    background-color: #f7d1ff;
                    color: #111;
                }
                th{
                    text-align: right;
                }
                td{
                    width: 90px;
                    text-align: right;
                    padding-top: 6px;
                    padding-bottom: 6px;
                }
                tr{
                    border: 1px solid #AAA; 
                }
                table {
                    font-size: 12pt;
                    margin-left: auto;
                    margin-right: auto;
                    border-collapse: collapse;
                    table-layout: fixed;
                    border-style: hidden;
                }
                div {
                    align-content: center;
                    padding-top: 5px;
                    padding-right: 10px;
                    padding-left: 10px;
                    padding-bottom: 10px;
                    margin: auto;
                    background-color: white;
                    display:table;
                    border-radius: 10px;
                    position: relative;
                }
                .unfixedWidth {
                    width: auto;
                }
                .teamHeader {
                    background-color: #f7d1ff ;
                    color: #9755A5;
                    font-size: 30pt;
                    font-weight: bold;
                }
                .divTitle {
                    margin-left: auto;
                    margin-right: auto;
                    font-size: 22pt;
                }
                @media only screen and (orientation: portrait) {
                    table {
                        font-size: 18pt;
                    }
                    td {
                        width: 135px;
                    }
                    .divTitle {
                        font-size: 30pt;
                    }
                    .teamHeader{
                        font-size: 36pt;
                    }
                }
            </style>
        </head>
        <body>
            <div class='teamHeader'>
                <a>Boston Flowers ðŸŒ¹</a>
            </div>

            <!-- <div id='matrixDiv'> -->

            <!-- </div> -->
            <div id='pickTableDiv'>
                <div class="divTitle">
                    <a>Will Chances</a>
                </div>
            </div>
            <br>
            <div id='comboTableDiv'>
                <div class="divTitle">
                    <a>Most Likely Outcomes</a>
                </div>
            </div>
            <script>

                $.ajaxSetup({async:false})

                var willNames = []
                $.getJSON("https://api.sibr.dev/proxy/database/offseasonSetup", populateWillNames)

                $.getJSON("https://api.sibr.dev/proxy/database/teamElectionStats", {
                                'id': '3f8bbb15-61c0-4e3f-8e4a-907a5fb1565e'
                            }, createTable)

                function createTable(electionStats){

                    let wills = electionStats.wills
                    wills.sort(function(a,b){
                        return b.percent - a.percent
                    })

                    let individualPercentages = getIndividualPercentages(wills)
                    
                    // var freeWillMatrix = calculate3DProbabilityMatrix(individualPercentages)
                    // freeWillMatrix.forEach(innerMatrix => printTable(innerMatrix))

                    let matrix = calculateProbabilityMatrix(individualPercentages)
                    // printTable(matrix)
                    
                    let secondPickPercentages = calculate2ndPickProbabilities(matrix)

                    let pickTable = document.createElement('table')
                    let tableBody = document.createElement('tbody')

                    let headerRow = document.createElement('tr')
                    headerRow.style.border = '2px solid black'
                    let headerCell = document.createElement('th')
                    headerCell.appendChild(document.createTextNode('WILL'))
                    headerRow.appendChild(headerCell)
                    headerCell = document.createElement('th')
                    headerCell.appendChild(document.createTextNode('1ST'))
                    headerRow.appendChild(headerCell)
                    headerCell = document.createElement('th')
                    headerCell.appendChild(document.createTextNode('2ND'))
                    headerRow.appendChild(headerCell)
                    headerCell = document.createElement('th')
                    headerCell.appendChild(document.createTextNode('TOTAL'))
                    headerRow.appendChild(headerCell)
                    tableBody.appendChild(headerRow)

                    for (let i = 0; i < wills.length; i++){
                        let tableRow = document.createElement('tr')
                        let tableCell = document.createElement('td')
                        let lessThan = isTiny(wills[i].percent)
                        tableCell.appendChild(document.createTextNode(willNames[wills[i].id]))
                        tableCell.className = 'unfixedWidth'
                        tableRow.appendChild(tableCell)
                        tableCell = document.createElement('td')
                        tableCell.appendChild(document.createTextNode(formatPercentage(wills[i].percent), lessThan))
                        tableRow.appendChild(tableCell)
                        tableCell = document.createElement('td')
                        tableCell.appendChild(document.createTextNode(formatPercentage(secondPickPercentages[i] * 100, lessThan)))
                        tableRow.appendChild(tableCell)
                        tableCell = document.createElement('td')
                        tableCell.appendChild(document.createTextNode(formatPercentage((secondPickPercentages[i] + individualPercentages[i]) * 100, lessThan)))
                        tableRow.appendChild(tableCell)
                        tableBody.appendChild(tableRow)
                    }
                    pickTable.appendChild(tableBody)
                    document.getElementById('pickTableDiv').appendChild(pickTable)


                    let orderedCombos = calculateOrderedCombinationProbabilities(wills, matrix)
                    orderedCombos.sort(function(a,b){
                        return b.value - a.value
                    })

                    let comboTable = document.createElement('table')
                    let comboTableBody = document.createElement('tbody')
                    let hdRow = document.createElement('tr')
                    let hdCell = document.createElement('th')
                    hdCell.colSpan = 4
                    hdRow.appendChild(hdCell)
                    hdRow.style.border = '2px solid black'
                    comboTableBody.appendChild(hdRow)
                    let topTenSum = 0
                    for (let i = 0; i < 10 && i < orderedCombos.length; i++){
                        let row = document.createElement('tr')
                        let cell = document.createElement('th')
                        // let lessThan = false
                        // orderedCombos[i].combination.forEach(willIndex => lessThan |= isTiny(wills[willIndex].percent))
                        // cell.appendChild(document.createTextNode(getCombinationDisplayString(orderedCombos[i].combination)))
                        cell.appendChild(document.createTextNode(willNames[orderedCombos[i].combination[0]]))
                        cell.style.textAlign = 'right'
                        cell.style.width = 'auto'
                        row.appendChild(cell)
                        cell = document.createElement('td')
                        cell.appendChild(document.createTextNode(' and '))
                        cell.style.textAlign = 'center'
                        cell.style.width = 'auto'
                        cell.style.paddingLeft = '5px'
                        cell.style.paddingRight = '5px'
                        row.appendChild(cell)
                        cell = document.createElement('th')
                        cell.appendChild(document.createTextNode(willNames[orderedCombos[i].combination[1]]))
                        cell.style.textAlign = 'left'
                        cell.style.width = 'auto'
                        row.appendChild(cell)
                        cell = document.createElement('td')
                        topTenSum += (orderedCombos[i].value * 100)
                        cell.appendChild(document.createTextNode(formatPercentage(orderedCombos[i].value * 100), false))
                        row.appendChild(cell)
                        comboTableBody.appendChild(row)
                    }

                    let otherRow = document.createElement('tr')
                    otherRow.style.border = '2px solid black'
                    let otherCell = document.createElement('th')
                    otherCell.colSpan = 3
                    otherCell.appendChild(document.createTextNode('Other Outcomes'))
                    otherRow.appendChild(otherCell)
                    otherCell = document.createElement('td')
                    otherCell.appendChild(document.createTextNode(formatPercentage(100 - topTenSum, false)))
                    otherRow.appendChild(otherCell)
                    comboTableBody.appendChild(otherRow)

                    comboTable.appendChild(comboTableBody)
                    document.getElementById('comboTableDiv').appendChild(comboTable)
                }

                function populateWillNames(offSeasonData){
                    offSeasonData.wills.forEach(will => {
                        willNames[will.id] = will.title
                    })
                }

                function printTable(probabilityMatrix){

                    let willTable = document.createElement('table')
                    let tableBody = document.createElement('tbody')
                    probabilityMatrix.forEach(matrixRow => {
                        let tableRow = document.createElement('tr')
                        matrixRow.forEach(matrixCell => {
                            let tableCell = document.createElement('td')
                            tableCell.appendChild(document.createTextNode(round(matrixCell * 100, 2)))
                            tableRow.appendChild(tableCell)
                        })
                        tableBody.appendChild(tableRow)
                    })
                    willTable.appendChild(tableBody)
                    document.getElementById('matrixDiv').appendChild(willTable)
                }

                function getIndividualPercentages(wills){
                    let percentages = []
                    let total = 0
                    wills.forEach(will => {
                        total += Math.max(parseFloat(will.percent), 0.05)
                    })
                    
                    for (let i = 0; i < wills.length; i++){
                        percentages[i] = Math.max(parseFloat(wills[i].percent), 0.05) / total
                    }
                    return percentages
                }

                function calculateProbabilityMatrix(individualPercentages){
                    let percentages = []
                    for (let x = 0; x < individualPercentages.length; x++){
                        percentages[x] = []
                        let remaining = 1 - individualPercentages[x]
                        for (let y = 0; y < individualPercentages.length; y++){
                            let yProb = 0
                            if (x != y){
                                yProb = individualPercentages[y]/remaining
                            }
                            percentages[x][y] = (yProb * individualPercentages[x])
                        }
                    }
                    return percentages
                }

                function calculate3DProbabilityMatrix(individualPercentages){
                    let percentages = []
                    for (let x = 0; x < individualPercentages.length; x++){
                        percentages[x] = []
                        let xProb = individualPercentages[x]
                        let remaining = 1 - individualPercentages[x]
                        for (let y = 0; y < individualPercentages.length; y++){
                            percentages[x][y] = []
                            let stillRemaining = remaining - individualPercentages[y]
                            let yProb = 0
                            if (x != y){
                                yProb = individualPercentages[y]/remaining
                            }
                            for (let z = 0; z < individualPercentages.length; z++){
                                zProb = 0
                                if (x != z && y != z){
                                    zProb = individualPercentages[z]/stillRemaining
                                }
                                percentages[x][y][z] = xProb * yProb * zProb
                            }
                        }
                    }
                    return percentages
                }

                function calculateOrderedCombinationProbabilities(wills, probabilityMatrix)
                {
                    let combinations = []
                    for (let x = 0; x < probabilityMatrix.length-1; x++){
                        for (let y = x+1; y < probabilityMatrix.length; y++){
                            let entry = {}
                            entry.combination = [wills[x].id,wills[y].id]
                            entry.value = probabilityMatrix[x][y] + probabilityMatrix[y][x]
                            combinations.push(entry)
                        }
                    }
                    return combinations
                }

                function calculate2ndPickProbabilities(probabilityMatrix){
                    let pickProbabilities = []
                    for (let y = 0; y < probabilityMatrix.length; y++){
                        let pickProbability = 0
                        for (let x = 0; x < probabilityMatrix.length; x++){
                            pickProbability += probabilityMatrix[x][y]
                        }
                        pickProbabilities[y] = pickProbability
                    }
                    return pickProbabilities
                }


                function isTiny(aNumber){
                    return parseFloat(aNumber) == 0
                }

                function formatPercentage(percentage, lessThan){
                    let rounded = percentage == 0 ? 0.05 : percentage
                    rounded = round(percentage, 2)
                    let reallyLessThan = lessThan || (rounded == 0)
                    rounded = (Math.max(round(percentage, 2), 0.05)).toFixed(2)
                    rounded = reallyLessThan ? '< ' + rounded : ' ' + rounded
                    return rounded + '%'
                }

                function round(toBeRounded, decimalPlaces){
                    let multiplier = Math.pow(10, decimalPlaces)
                    return Math.round(toBeRounded * multiplier) / multiplier
                }

                function getCombinationDisplayString(combinationIds){
                    let comboString = willNames[combinationIds[0]]
                    for (i = 1; i < combinationIds.length; i++){
                        comboString += ", "
                        comboString += willNames[combinationIds[i]]
                    }
                    return comboString
                }

            </script>
        </body>
    </html>
