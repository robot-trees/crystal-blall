<!DOCTYPE html>
    <html>
        <head>
            <title>Will Probabilities</title>
            <meta charset="UTF-8">
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
            <style>
                body{
                    align-content: center;
                    font-family: arial;
                }
                table, th, td{
                    border: 1px solid black;
                }
                td{
                    text-align: center;
                }
                table {
                    margin-left: auto;
                    margin-right: auto;
                    border-collapse: collapse;
                    width: 50%;
                    table-layout: fixed;
                }
                div {
                    align-content: center;
                    padding: 10px;
                }
            </style>
        </head>
        <body>
            <div id='matrixDiv'>

            </div>
            <div id='pickTableDiv'>
                
            </div>
            <script>

                $.ajaxSetup({async:false})

                var willNames = []
                $.getJSON("https://api.sibr.dev/proxy/database/offseasonSetup", populateWillNames)

                $.getJSON("https://api.sibr.dev/proxy/database/teamElectionStats", {
                                'id': '3f8bbb15-61c0-4e3f-8e4a-907a5fb1565e'
                            }, createTable)

                function createTable(electionStats){

                    var wills = electionStats.wills
                    wills.sort(function(a,b){
                        return b.percent - a.percent
                    })

                    var individualPercentages = getIndividualPercentages(wills)
                    
                    // var freeWillMatrix = calculate3DProbabilityMatrix(individualPercentages)
                    // freeWillMatrix.forEach(innerMatrix => printTable(innerMatrix))

                    var matrix = calculateProbabilityMatrix(individualPercentages)
                    printTable(matrix)
                    
                    var secondPickPercentages = calculate2ndPickProbabilities(matrix)

                    var pickTable = document.createElement('table')
                    var tableBody = document.createElement('tbody')

                    for (let i = 0; i < wills.length; i++){
                        var tableRow = document.createElement('tr')
                        var tableCell = document.createElement('th')
                        tableCell.appendChild(document.createTextNode(willNames[wills[i].id]))
                        tableRow.appendChild(tableCell)
                        tableCell = document.createElement('td')
                        tableCell.appendChild(document.createTextNode(round(wills[i].percent, 2)))
                        tableRow.appendChild(tableCell)
                        tableCell = document.createElement('td')
                        tableCell.appendChild(document.createTextNode(round(secondPickPercentages[i] * 100, 2)))
                        tableRow.appendChild(tableCell)
                        tableCell = document.createElement('td')
                        tableCell.appendChild(document.createTextNode(round((secondPickPercentages[i] + individualPercentages[i]) * 100, 2)))
                        tableRow.appendChild(tableCell)
                        tableBody.appendChild(tableRow)
                    }
                    pickTable.appendChild(tableBody)
                    document.getElementById('pickTableDiv').appendChild(pickTable)
                }

                function populateWillNames(offSeasonData){
                    offSeasonData.wills.forEach(will => {
                        willNames[will.id] = will.title
                    })
                }

                function printTable(probabilityMatrix){

                    var willTable = document.createElement('table')
                    var tableBody = document.createElement('tbody')
                    probabilityMatrix.forEach(matrixRow => {
                        var tableRow = document.createElement('tr')
                        matrixRow.forEach(matrixCell => {
                            var tableCell = document.createElement('td')
                            tableCell.appendChild(document.createTextNode(round(matrixCell * 100, 2)))
                            tableRow.appendChild(tableCell)
                        })
                        tableBody.appendChild(tableRow)
                    })
                    willTable.appendChild(tableBody)
                    document.getElementById('matrixDiv').appendChild(willTable)
                }


                function getIndividualPercentages(wills){
                    var percentages = []
                    var total = 0
                    wills.forEach(will => {total += (parseFloat(will.percent))})
                    
                    for (let i = 0; i < wills.length; i++){
                        percentages[i] = wills[i].percent / total
                    }
                    return percentages
                }

                function calculateProbabilityMatrix(individualPercentages){
                    var percentages = []
                    for (let x = 0; x < individualPercentages.length; x++){
                        percentages[x] = []
                        var remaining = 1 - individualPercentages[x]
                        for (let y = 0; y < individualPercentages.length; y++){
                            var yProb = 0
                            if (x != y){
                                yProb = individualPercentages[y]/remaining
                            }
                            percentages[x][y] = (yProb * individualPercentages[x])
                        }
                    }
                    return percentages
                }

                function calculate3DProbabilityMatrix(individualPercentages){
                    var percentages = []
                    for (let x = 0; x < individualPercentages.length; x++){
                        percentages[x] = []
                        var xProb = individualPercentages[x]
                        var remaining = 1 - individualPercentages[x]
                        for (let y = 0; y < individualPercentages.length; y++){
                            percentages[x][y] = []
                            var stillRemaining = remaining - individualPercentages[y]
                            var yProb = 0
                            if (x != y){
                                yProb = individualPercentages[y]/remaining
                            }
                            for (let z = 0; z < individualPercentages.length; z++){
                                zProb = 0
                                if (x != z && y != z){
                                    zProb = individualPercentages[z]/stillRemaining
                                }
                                percentages[x][y][z] = xProb * yProb * zProb
                            }
                        }
                    }
                    return percentages
                }

                function calculate2ndPickProbabilities(probabilityMatrix){
                    var pickProbabilities = []
                    for (let y = 0; y < probabilityMatrix.length; y++){
                        var pickProbability = 0
                        for (let x = 0; x < probabilityMatrix.length; x++){
                            pickProbability += probabilityMatrix[x][y]
                        }
                        pickProbabilities[y] = pickProbability
                    }
                    return pickProbabilities
                }

                function round(toBeRounded, decimalPlaces){
                    var multiplier = Math.pow(10, decimalPlaces)
                    return Math.round(toBeRounded * multiplier) / multiplier
                }

            </script>
        </body>
    </html>
